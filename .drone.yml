pipeline:
  restore-cache:
    image: drillster/drone-volume-cache
    restore: true
    mount:
      - /drone/docker
    volumes:
      - /tmp/cache:/cache

  generate-tag-name:
    image: alpine
    commands:
      - echo $DRONE_BRANCH-${DRONE_COMMIT_SHA:0:7} | sed 's:/:-:' | tee .tags

  restore:
    image: plugins/s3-cache
    pull: true
    restore: true
    secrets:
      - source: access_key
        target: aws_access_key_id
      - source: secret_key
        target: aws_secret_access_key

  # access_key:
  #   from_secret: aws_access_key_id
  # secret_key:
  #   from_secret: aws_secret_access_key
  #
  # precompile-assets:
  #   image: alpine
  #   commands:
  #     -

      # pull assets from the cache
      # precompile assets
      # push assets to cache

  ecr:
    image: plugins/ecr
    repo: shopping
    registry: 581987047035.dkr.ecr.ap-southeast-2.amazonaws.com
    region: ap-southeast-2
    storage_path: /drone/docker
    secrets:
      - source: access_key
        target: aws_access_key_id
      - source: secret_key
        target: aws_secret_access_key

  rebuild-cache:
    image: drillster/drone-volume-cache
    rebuild: true
    mount:
      - /drone/docker
    # Mount the cache volume, needs "Trusted"
    volumes:
      - /tmp/cache:/cache
